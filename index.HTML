<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMSY | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0b1121', 800: '#151e32', 700: '#2a3b55' },
                        brand: { cyan: '#06b6d4', blue: '#3b82f6', orange: '#f97316', green: '#10b981', red: '#ef4444', yellow: '#eab308', purple: '#8b5cf6', slate: '#64748b' }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Screen Styles --- */
        body {
            background-color: #0b1121;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(6, 182, 212, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(249, 115, 22, 0.05), transparent 25%);
            color: #e2e8f0;
        }

        .glass-card {
            background: rgba(21, 30, 50, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(6, 182, 212, 0.3);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.4);
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(11, 17, 33, 0.95);
            backdrop-filter: blur(5px);
            z-index: 50; display: none;
            justify-content: center; align-items: flex-start;
            padding-top: 2rem; padding-bottom: 2rem;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #151e32; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 1.5rem; width: 95%; max-width: 1200px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: auto; min-height: 80vh;
        }

        .table-input {
            background: transparent; border: 1px solid transparent; width: 100%; color: white;
            text-align: center; padding: 6px; outline: none; border-radius: 4px;
        }
        .table-input:focus, .table-input:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); }
        
        .editable-active { outline: 2px dashed #06b6d4; background: rgba(6, 182, 212, 0.1); }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white !important; color: black !important; font-size: 10pt; }
            .no-print, #editBtn, header button, .add-row-btn, .remove-row-btn, .nav-btn { display: none !important; }
            
            /* Print Specific Visibility */
            .print-only { display: block !important; }
            .screen-only { display: none !important; }

            /* Modal Logic for Print */
            body.modal-open > *:not(.modal-overlay) { display: none !important; }
            body.modal-open .modal-overlay { 
                position: static; background: white; display: block; overflow: visible; padding: 0;
            }
            body.modal-open .modal-content {
                width: 100%; max-width: none; border: none; box-shadow: none; background: white; color: black; margin: 0; min-height: auto;
            }
            
            /* Table Styling */
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; page-break-inside: avoid; }
            th, td { border: 1px solid #000 !important; padding: 6px; text-align: center; color: black !important; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            
            /* Reset Colors */
            .text-white { color: black !important; }
            .text-slate-400 { color: #333 !important; }
            .bg-slate-800, .bg-slate-900, .glass-card { background: white !important; border: 1px solid #ccc !important; }
            
            /* Report Sections */
            .engineer-report-page { page-break-after: always; margin-bottom: 2rem; border-bottom: 1px dashed #ccc; padding-bottom: 2rem; }
            .engineer-report-page:last-child { page-break-after: auto; }

            canvas { max-height: 400px !important; width: 100% !important; filter: none !important; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 antialiased">

    <!-- Top Control Bar -->
    <div class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center bg-slate-800/80 p-4 rounded-2xl border border-slate-700 no-print">
        <div class="flex items-center gap-4">
            <label class="text-sm text-slate-400">ğŸ“… Ø§Ù„Ø´Ù‡Ø±:</label>
            <select id="monthSelector" onchange="changeMonth()" class="bg-slate-900 text-white border border-slate-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 outline-none"></select>
            <button onclick="createNewMonth()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-bold transition">+ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="flex gap-3 mt-4 md:mt-0">
            <button onclick="toggleEditMode()" id="editBtn" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold transition"><span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ</button>
            <button onclick="window.print()" class="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold transition"><span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ù…Ø©</button>
            <button onclick="resetCurrentMonth()" class="bg-red-900/50 hover:bg-red-900 text-red-200 px-3 py-2 rounded-lg text-sm transition">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
    </div>

    <!-- Main Header -->
    <header class="max-w-7xl mx-auto mb-8 border-b border-slate-700 pb-6">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-black text-white tracking-tight editable-text" data-id="main-title">
                    Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØµÙ†Ø¹ <span class="text-cyan-500 print:text-black">IMSY</span>
                </h1>
                <p class="text-slate-400 mt-1 editable-text" data-id="main-subtitle">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</p>
            </div>
            <div class="text-left">
                <div class="text-sm text-slate-500">Ø§Ù„ÙØªØ±Ø©</div>
                <div class="text-2xl font-bold text-white print:text-black" id="displayPeriod">...</div>
            </div>
        </div>
    </header>

    <!-- Overview Section -->
    <section class="max-w-7xl mx-auto mb-8">
        <div class="glass-card p-6 md:p-8">
            <div class="flex flex-col md:flex-row items-center gap-8">
                <div class="w-full md:w-1/3">
                    <h2 class="text-2xl font-bold text-white mb-4">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</h2>
                    <div class="space-y-4">
                        <div class="bg-slate-900/50 print:bg-gray-100 p-4 rounded-lg border border-slate-700 print:border-gray-300">
                            <div class="text-sm text-slate-400">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙƒÙ„ÙŠ</div>
                            <div class="text-3xl font-bold text-cyan-400 print:text-black" id="overallScore">0%</div>
                        </div>
                        <div class="p-4 rounded-lg border border-dashed border-slate-600">
                            <div class="text-sm text-slate-400 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</div>
                            <p class="text-sm text-white editable-text print:text-black" data-id="manager-notes">
                                Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµÙ†Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±...
                            </p>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-2/3 h-64">
                    <canvas id="mainRadarChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Departments Grid -->
    <main class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        <!-- Generated by JS -->
    </main>

    <!-- Modal Container -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content p-6 md:p-10" onclick="event.stopPropagation()">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4 no-print">
                <div>
                    <h2 id="modalTitle" class="text-3xl font-black text-white mb-1"></h2>
                    <p class="text-slate-400 text-sm">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    <button onclick="closeModalBtn()" class="text-2xl text-slate-400 hover:text-white ml-4 bg-slate-800 w-10 h-10 rounded-full flex items-center justify-center">âœ•</button>
                </div>
            </div>

            <!-- Modal Body (Dynamic Injection) -->
            <div id="modalBody"></div>

        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50">ØªÙ… Ø§Ù„Ø­ÙØ¸!</div>

    <script>
        // --- 1. CONFIGURATION ---
        const defaultDeptStructure = {
            'managers': {
                title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµÙ†Ø¹ ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†', icon: 'ğŸ‘”', color: '#64748b',
                isSummary: true,
                kpiLabels: [], values: []
            },
            'tech': { 
                title: 'Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ', icon: 'ğŸ“', color: '#3b82f6', 
                engineers: [], // Array of objects
                kpiLabels: ['Ø¯Ù‚Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…', 'Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²'], values: [85, 90] 
            },
            'prod': { 
                title: 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬', icon: 'âš™ï¸', color: '#f97316', 
                kpiLabels: ['Ø§Ù„Ø®Ø·Ø©', 'Ø§Ù„ÙƒÙØ§Ø¡Ø©', 'Ø§Ù„Ù‡Ø§Ù„Ùƒ'], values: [90, 85, 95],
                tasks: ['Laser Cutting', 'Bending', 'Assembly'], notes: '...'
            },
            'qual': { 
                title: 'Ø§Ù„Ø¬ÙˆØ¯Ø©', icon: 'ğŸ›¡ï¸', color: '#10b981', 
                kpiLabels: ['Ø§Ù„Ù‚Ø¨ÙˆÙ„', 'Ø§Ù„ÙØ­Øµ', 'Ø§Ù„Ø¹Ù…ÙŠÙ„'], values: [95, 92, 98],
                tasks: ['Incoming QC', 'Final QC'], notes: '...'
            },
            'maint': { 
                title: 'Ø§Ù„ØµÙŠØ§Ù†Ø©', icon: 'ğŸ”§', color: '#ef4444', 
                kpiLabels: ['Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©', 'Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©'], values: [88, 90],
                tasks: ['Preventive', 'Corrective'], notes: '...'
            },
            'store': { 
                title: 'Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†', icon: 'ğŸ“¦', color: '#8b5cf6', 
                kpiLabels: ['ØªÙˆÙÙŠØ± Ø§Ù„Ø®Ø§Ù…Ø§Øª', 'Ø¯Ù‚Ø© Ø§Ù„Ø¬Ø±Ø¯', 'ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª'], values: [92, 96, 90],
                managerName: '',
                inventoryLog: [], 
                shortageLog: []
            },
            'safety': { 
                title: 'Ø§Ù„Ø³Ù„Ø§Ù…Ø©', icon: 'ğŸ¦º', color: '#eab308', 
                kpiLabels: ['PPE', 'Ø§Ù„Ø­ÙˆØ§Ø¯Ø«'], values: [98, 100],
                tasks: ['PPE Check', 'Training'], notes: '...'
            }
        };

        // --- 2. DB MANAGEMENT (V9.2 Fixed) ---
        let db = JSON.parse(localStorage.getItem('IMSY_DB_V9_2')) || {};
        let currentMonthKey = localStorage.getItem('IMSY_CURRENT_MONTH_V9_2');

        if (Object.keys(db).length === 0) {
            const now = new Date();
            const key = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            db[key] = { depts: JSON.parse(JSON.stringify(defaultDeptStructure)), texts: {} };
            currentMonthKey = key;
            saveDB();
        }
        if (!currentMonthKey || !db[currentMonthKey]) currentMonthKey = Object.keys(db).sort().pop();

        function saveDB() {
            localStorage.setItem('IMSY_DB_V9_2', JSON.stringify(db));
            localStorage.setItem('IMSY_CURRENT_MONTH_V9_2', currentMonthKey);
            showToast();
        }
        function getCurrentData() { return db[currentMonthKey]; }
        function showToast() { const t = document.getElementById('toast'); t.style.opacity='1'; setTimeout(()=>t.style.opacity='0', 1000); }
        function init() { renderMonthSelector(); renderDashboard(); }

        // --- 3. RENDERING DASHBOARD ---
        let mainRadarChartInstance = null;

        function renderDashboard() {
            const data = getCurrentData();
            document.getElementById('displayPeriod').innerText = currentMonthKey;
            
            // 1. Render Chart
            updateMainRadarChart(data);

            // 2. Render Cards
            const container = document.querySelector('main');
            container.innerHTML = ''; 

            Object.entries(data.depts).forEach(([key, dept]) => {
                let avg = 0;
                if (key === 'managers') {
                    let total = 0, count = 0;
                    Object.entries(data.depts).forEach(([k, d]) => {
                        if (k !== 'managers') {
                            if(d.values && d.values.length > 0) {
                                total += d.values.reduce((a,b)=>a+b,0)/d.values.length;
                                count++;
                            }
                        }
                    });
                    avg = count ? Math.round(total/count) : 0;
                } else if(key === 'tech' && dept.engineers && dept.engineers.length > 0) {
                    let total = 0;
                    dept.engineers.forEach(e => total += (100 - (e.errorCount || 0) * 5));
                    avg = Math.max(0, Math.round(total / dept.engineers.length));
                } else if(dept.values && dept.values.length > 0) {
                    avg = Math.round(dept.values.reduce((a, b) => a + b, 0) / dept.values.length);
                } else {
                    avg = 0;
                }
                
                const card = document.createElement('div');
                card.className = 'glass-card p-6 group';
                card.onclick = () => openModal(key);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl transition" 
                             style="background: ${dept.color}20; color: ${dept.color}">${dept.icon}</div>
                        <div class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded font-bold">${avg}%</div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">${dept.title}</h3>
                    <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden mb-2">
                        <div class="h-full" style="width: ${avg}%; background-color: ${dept.color}"></div>
                    </div>
                    <p class="text-xs text-slate-400">${key==='tech' ? (dept.engineers ? dept.engineers.length : 0) + ' Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†' : (key==='managers' ? 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†' : 'Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„')}</p>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.editable-text').forEach(el => {
                const id = el.getAttribute('data-id');
                if(data.texts && data.texts[id]) el.innerText = data.texts[id];
            });
        }

        function updateMainRadarChart(data) {
            const ctx = document.getElementById('mainRadarChart').getContext('2d');
            const labels = [];
            const values = [];
            let totalSum = 0; 
            let count = 0;

            Object.entries(data.depts).forEach(([key, dept]) => {
                if (key === 'managers') return; 
                
                labels.push(dept.title);
                let avg = 0;
                if(dept.title.includes('Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ') && dept.engineers && dept.engineers.length > 0) {
                     let total = 0;
                     dept.engineers.forEach(e => total += (100 - (e.errorCount || 0) * 5));
                     avg = Math.max(0, Math.round(total / dept.engineers.length));
                } else {
                    avg = dept.values.length ? dept.values.reduce((a,b)=>a+b,0) / dept.values.length : 0;
                }
                values.push(avg);
                totalSum += avg;
                count++;
            });

            document.getElementById('overallScore').innerText = (count ? Math.round(totalSum/count) : 0) + '%';

            if (mainRadarChartInstance) mainRadarChartInstance.destroy();

            mainRadarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ',
                        data: values,
                        backgroundColor: 'rgba(6, 182, 212, 0.2)',
                        borderColor: '#06b6d4',
                        pointBackgroundColor: '#fff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#94a3b8', font: { size: 11 } },
                            suggestedMin: 0, suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 4. MODAL LOGIC (FIXED) ---
        let currentModalKey = null;
        let currentView = 'list'; // UNIFIED Variable Name
        let currentEngIndex = null;

        function openModal(key) {
            currentModalKey = key;
            const data = getCurrentData().depts[key];
            document.getElementById('modalTitle').innerText = data.title;
            document.body.classList.add('modal-open');
            
            // Reset state on fresh open
            currentView = 'list';
            currentEngIndex = null;

            renderModalContent();
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModalBtn() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.classList.remove('modal-open');
            renderDashboard(); 
        }
        function closeModal(e) { if(e.target.id === 'modalOverlay') closeModalBtn(); }

        function renderModalContent() {
            const data = getCurrentData().depts[currentModalKey];
            const container = document.getElementById('modalBody');
            
            const managerHtml = currentModalKey === 'managers' ? '' : `
                <div class="mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-4">
                    <span class="text-slate-400">ğŸ‘¤ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù‚Ø³Ù…:</span>
                    <input class="bg-transparent border-b border-slate-600 text-white outline-none focus:border-cyan-500" 
                           value="${data.managerName || ''}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§" onblur="updateManager(this.value)">
                </div>`;

            if (currentModalKey === 'managers') renderManagers(container);
            else if (currentModalKey === 'tech') renderTech(data, container, managerHtml);
            else if (currentModalKey === 'prod') renderProd(data, container, managerHtml);
            else if (currentModalKey === 'store') renderStore(data, container, managerHtml);
            else renderGeneric(data, container, managerHtml); 
        }

        function updateManager(val) {
            getCurrentData().depts[currentModalKey].managerName = val;
            saveDB();
        }

        // --- 5. MANAGERS VIEW ---
        function renderManagers(container) {
            const data = getCurrentData();
            let rows = '';
            
            Object.entries(data.depts).forEach(([key, dept]) => {
                if (key === 'managers') return; 
                
                let avg = 0;
                if(key === 'tech' && dept.engineers) {
                    let total = 0;
                    (dept.engineers||[]).forEach(e => total += (100 - (e.errorCount || 0) * 5));
                    avg = (dept.engineers||[]).length ? Math.max(0, Math.round(total / dept.engineers.length)) : 0;
                } else if(dept.values) {
                    avg = dept.values.length ? Math.round(dept.values.reduce((a,b)=>a+b,0)/dept.values.length) : 0;
                }

                let statusColor = 'text-red-400';
                let statusText = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
                if (avg >= 90) { statusColor = 'text-green-400'; statusText = 'Ù…Ù…ØªØ§Ø²'; }
                else if (avg >= 80) { statusColor = 'text-blue-400'; statusText = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'; }
                else if (avg >= 70) { statusColor = 'text-yellow-400'; statusText = 'Ø¬ÙŠØ¯'; }

                rows += `
                    <tr class="border-b border-slate-700 hover:bg-slate-800/50 transition">
                        <td class="py-4 flex items-center gap-3">
                            <span class="text-xl" style="color: ${dept.color}">${dept.icon}</span>
                            <span class="text-white font-bold">${dept.title}</span>
                        </td>
                        <td>
                            <input class="bg-transparent border-b border-slate-600 text-center text-white focus:border-cyan-500 w-full"
                                   value="${dept.managerName || ''}" placeholder="ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
                                   onblur="updateSpecificManager('${key}', this.value)">
                        </td>
                        <td>
                            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                                <div class="h-full" style="width: ${avg}%; background-color: ${dept.color}"></div>
                            </div>
                            <div class="text-xs text-center mt-1 text-slate-400">${avg}%</div>
                        </td>
                        <td class="font-bold ${statusColor}">${statusText}</td>
                    </tr>
                `;
            });

            container.innerHTML = `
                <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                    <h3 class="text-xl font-bold text-white mb-6 border-b border-slate-600 pb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
                    <table class="w-full text-sm text-center">
                        <thead>
                            <tr class="text-slate-500 border-b border-slate-600">
                                <th class="pb-3 text-right">Ø§Ù„Ù‚Ø³Ù…</th>
                                <th class="pb-3">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                <th class="pb-3 w-1/4">Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
                                <th class="pb-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    
                    <div class="mt-8 pt-4 border-t border-slate-700 flex justify-end no-print">
                        <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                            <span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                        </button>
                    </div>

                    <div class="hidden print:block mt-12 pt-8 border-t border-black">
                        <div class="flex justify-between text-center">
                            <div>ÙŠØ¹ØªÙ…Ø¯ØŒ<br><br><strong>Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</strong></div>
                            <div>Ø§Ù„ØªØ§Ø±ÙŠØ®:<br><br>____ / ____ / 2026</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateSpecificManager(key, val) {
            getCurrentData().depts[key].managerName = val;
            saveDB();
        }

        // --- 5. TECH & PROD Logic ---
        function renderTech(data, container, managerHtml) {
            if (currentView === 'list') {
                const list = (data.engineers || []).map((e, i) => `
                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between items-center mb-2">
                        <div><h4 class="font-bold text-white text-lg">${e.name||'Ø¬Ø¯ÙŠØ¯'}</h4><p class="text-xs text-slate-400">Ø£Ø®Ø·Ø§Ø¡: ${e.errorCount||0}</p></div>
                        <div class="flex gap-2"><button onclick="editSubItem(${i})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">ØªÙØ§ØµÙŠÙ„</button><button onclick="deleteSubItem('engineers', ${i})" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Ø­Ø°Ù</button></div>
                    </div>`).join('');
                container.innerHTML = `${managerHtml}<div class="flex justify-between items-center mb-4 no-print"><h3 class="text-cyan-400 font-bold">ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3><button onclick="addSubItem('engineers')" class="bg-green-600 text-white px-4 py-2 rounded">+ Ù…Ù‡Ù†Ø¯Ø³</button></div><div class="space-y-2 no-print">${list}</div>`;
            } else {
                const eng = data.engineers[currentSubIndex];
                const rows = (eng.machines||[]).map((m,i)=>`<tr><td><input class="table-input" value="${m.name}" onblur="updateEngArr(${currentSubIndex},'machines',${i},'name',this.value)"></td><td><input class="table-input" value="${m.notes}" onblur="updateEngArr(${currentSubIndex},'machines',${i},'notes',this.value)"></td><td class="no-print"><button onclick="removeEngArr(${currentSubIndex},'machines',${i})" class="text-red-400">Ã—</button></td></tr>`).join('');
                container.innerHTML = `<div class="flex items-center gap-4 mb-4 no-print"><button onclick="switchView('list')" class="bg-slate-700 text-white px-3 py-1 rounded">â¬… Ø¹ÙˆØ¯Ø©</button><h3 class="text-white font-bold text-xl">${eng.name}</h3></div><div class="bg-slate-800 p-4 rounded-xl mb-4"><label class="text-xs text-slate-400">Ø§Ù„Ø§Ø³Ù…</label><input class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white" value="${eng.name}" onblur="updateSubField('engineers','name',this.value)"></div><div class="bg-slate-900/50 p-4 rounded-xl"><div class="flex justify-between mb-2"><h4>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</h4><button onclick="addEngArr(${currentSubIndex},'machines')" class="no-print text-xs bg-blue-600 px-2 py-1 rounded text-white">+</button></div><table class="w-full text-sm text-slate-300"><thead><tr><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
        }

        function renderProd(data, container, managerHtml) {
            if (currentView === 'list') {
                const list = (data.workers || []).map((w, i) => `
                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between items-center mb-2">
                        <div><h4 class="font-bold text-white text-lg">${w.name||'Ø¬Ø¯ÙŠØ¯'}</h4><p class="text-xs text-orange-400">Ù…Ø§ÙƒÙŠÙ†Ø©: ${w.machine||'-'}</p></div>
                        <div class="flex gap-2"><button onclick="editSubItem(${i})" class="bg-orange-600 text-white px-3 py-1 rounded text-sm">Ø³Ø¬Ù„</button><button onclick="deleteSubItem('workers', ${i})" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Ø­Ø°Ù</button></div>
                    </div>`).join('');
                container.innerHTML = `${managerHtml}<div class="flex justify-between items-center mb-4 no-print"><h3 class="text-orange-400 font-bold">Ø·Ø§Ù‚Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬</h3><button onclick="addSubItem('workers')" class="bg-green-600 text-white px-4 py-2 rounded">+ Ø¹Ø§Ù…Ù„</button></div><div class="space-y-2 no-print">${list}</div>`;
            } else {
                const w = data.workers[currentSubIndex];
                container.innerHTML = `<div class="flex items-center gap-4 mb-4 no-print"><button onclick="switchView('list')" class="bg-slate-700 text-white px-3 py-1 rounded">â¬… Ø¹ÙˆØ¯Ø©</button><h3 class="text-white font-bold text-xl">${w.name}</h3></div><div class="grid grid-cols-2 gap-4 bg-slate-800 p-6 rounded-xl"><input class="w-full bg-slate-900 p-2 text-white border border-slate-600 rounded" value="${w.name}" onblur="updateSubField('workers','name',this.value)" placeholder="Ø§Ù„Ø§Ø³Ù…"><input class="w-full bg-slate-900 p-2 text-white border border-slate-600 rounded" value="${w.machine||''}" onblur="updateSubField('workers','machine',this.value)" placeholder="Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©"></div>`;
            }
        }

        // --- 7. STORES ---
        function renderStore(data, container, managerHtml) {
            if (!data.inventoryLog) data.inventoryLog = [{ item: '', qty: '', notes: '' }];
            if (!data.shortageLog) data.shortageLog = [{ item: '', date: '', status: '' }];

            const invRows = data.inventoryLog.map((r, i) => `<tr><td><input class="table-input" value="${r.item}" placeholder="Ø§Ù„ØµÙ†Ù" onblur="updateStoreArr('inventoryLog', ${i}, 'item', this.value)"></td><td><input class="table-input" value="${r.qty}" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" onblur="updateStoreArr('inventoryLog', ${i}, 'qty', this.value)"></td><td><input class="table-input" value="${r.notes}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" onblur="updateStoreArr('inventoryLog', ${i}, 'notes', this.value)"></td><td class="no-print"><button onclick="removeStoreArr('inventoryLog', ${i})" class="text-red-400 hover:text-red-300">Ã—</button></td></tr>`).join('');
            const shortRows = data.shortageLog.map((r, i) => `<tr><td><input class="table-input" value="${r.item}" placeholder="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ©" onblur="updateStoreArr('shortageLog', ${i}, 'item', this.value)"></td><td><input class="table-input" type="date" value="${r.date}" onblur="updateStoreArr('shortageLog', ${i}, 'date', this.value)"></td><td><select class="table-input bg-slate-800" onchange="updateStoreArr('shortageLog', ${i}, 'status', this.value)"><option value="pending" ${r.status==='pending'?'selected':''}>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option><option value="ordered" ${r.status==='ordered'?'selected':''}>ØªÙ… Ø§Ù„Ø·Ù„Ø¨</option><option value="received" ${r.status==='received'?'selected':''}>ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option></select></td><td class="no-print"><button onclick="removeStoreArr('shortageLog', ${i})" class="text-red-400 hover:text-red-300">Ã—</button></td></tr>`).join('');
            let sliders = '';
            data.kpiLabels.forEach((l, i) => { sliders += `<div class="mb-3"><div class="flex justify-between text-xs mb-1 text-slate-300"><span>${l}</span><span>${data.values[i]}%</span></div><input type="range" min="0" max="100" value="${data.values[i]}" oninput="updateVal(${i}, this.value)" style="width:100%; accent-color:${data.color}"></div>`; });

            container.innerHTML = `${managerHtml}<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6"><div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700"><h4 class="font-bold text-purple-400 mb-4">âš™ï¸ Ù…Ø¤Ø´Ø±Ø§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø®Ø²Ù†</h4>${sliders}</div><div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700 h-fit"><div class="flex justify-between mb-2 items-center"><h4 class="font-bold text-white">ğŸ“¦ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h4><button onclick="addStoreArr('inventoryLog')" class="no-print text-xs bg-purple-600 px-2 py-1 rounded text-white">+ ØµÙ†Ù</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-slate-300"><thead><tr class="border-b border-slate-600 text-slate-500"><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="no-print"></th></tr></thead><tbody>${invRows}</tbody></table></div></div></div><div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700"><div class="flex justify-between mb-2 items-center"><h4 class="font-bold text-red-400">ğŸš¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†ÙˆØ§Ù‚Øµ (Shortages)</h4><button onclick="addStoreArr('shortageLog')" class="no-print text-xs bg-red-600 px-2 py-1 rounded text-white">+ Ø·Ù„Ø¨</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-slate-300"><thead><tr class="border-b border-slate-600 text-slate-500"><th>Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="no-print"></th></tr></thead><tbody>${shortRows}</tbody></table></div></div>`;
        }

        // --- 8. GENERIC ---
        function renderGeneric(data, container, managerHtml) {
            if (!data.machinesLog) data.machinesLog = [{ name: '', issue: '' }];
            const rows = data.machinesLog.map((m, i) => `<tr><td><input class="table-input" value="${m.name}" placeholder="Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©" onblur="updateGenericArr('machinesLog', ${i}, 'name', this.value)"></td><td><input class="table-input" value="${m.issue}" placeholder="Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" onblur="updateGenericArr('machinesLog', ${i}, 'issue', this.value)"></td><td class="no-print"><button onclick="removeGenericArr('machinesLog', ${i})" class="text-red-400">Ã—</button></td></tr>`).join('');
            let sliders = '';
            data.kpiLabels.forEach((l, i) => { sliders += `<div class="mb-3"><div class="flex justify-between text-xs mb-1 text-slate-300"><span>${l}</span><span>${data.values[i]}%</span></div><input type="range" min="0" max="100" value="${data.values[i]}" oninput="updateVal(${i}, this.value)" style="width:100%; accent-color:${data.color}"></div>`; });
            container.innerHTML = `${managerHtml}<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700"><h4>âš™ï¸ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h4>${sliders}</div><div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700"><div class="flex justify-between mb-2"><h4>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</h4><button onclick="addGenericArr('machinesLog')" class="no-print text-xs bg-slate-600 px-2 py-1 rounded text-white">+</button></div><table class="w-full text-sm text-slate-300"><thead><tr><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th></th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
        }

        // --- Helper Actions ---
        function switchView(v) { currentView = v; renderModalContent(); }
        function addSubItem(type) { 
            const data = getCurrentData().depts[currentModalKey];
            if(!data[type]) data[type] = [];
            data[type].push(type==='engineers'?{name:'Ø¬Ø¯ÙŠØ¯',machines:[],errorCount:0}:{name:'Ø¬Ø¯ÙŠØ¯',machine:'',errors:0});
            saveDB(); currentSubIndex = data[type].length - 1; currentView = 'detail'; renderModalContent();
        }
        function editSubItem(i) { currentSubIndex = i; currentView = 'detail'; renderModalContent(); }
        function deleteSubItem(type, i) { if(confirm('Ø­Ø°ÙØŸ')) { getCurrentData().depts[currentModalKey][type].splice(i,1); saveDB(); renderModalContent(); } }
        function updateSubField(type, field, val) { getCurrentData().depts[currentModalKey][type][currentSubIndex][field] = val; saveDB(); }
        function addEngArr(eIdx, arr) { const e = getCurrentData().depts[currentModalKey].engineers[eIdx]; if(!e[arr]) e[arr]=[]; e[arr].push({}); saveDB(); renderModalContent(); }
        function updateEngArr(eIdx, arr, iIdx, key, val) { getCurrentData().depts[currentModalKey].engineers[eIdx][arr][iIdx][key] = val; saveDB(); }
        function removeEngArr(eIdx, arr, iIdx) { getCurrentData().depts[currentModalKey].engineers[eIdx][arr].splice(iIdx,1); saveDB(); renderModalContent(); }
        
        function addGenericArr(arr) { const d = getCurrentData().depts[currentModalKey]; if(!d[arr]) d[arr]=[]; d[arr].push({}); saveDB(); renderModalContent(); }
        function updateGenericArr(arr, idx, key, val) { getCurrentData().depts[currentModalKey][arr][idx][key] = val; saveDB(); }
        function removeGenericArr(arr, idx) { getCurrentData().depts[currentModalKey][arr].splice(idx, 1); saveDB(); renderModalContent(); }
        function updateVal(idx, val) { getCurrentData().depts[currentModalKey].values[idx] = Number(val); saveDB(); renderDashboard(); }
        
        function addStoreArr(arrName) {
            const data = getCurrentData().depts['store'];
            if (arrName === 'inventoryLog') data.inventoryLog.push({ item: '', qty: '', notes: '' });
            if (arrName === 'shortageLog') data.shortageLog.push({ item: '', date: new Date().toISOString().split('T')[0], status: 'pending' });
            saveDB(); renderModalContent();
        }
        function updateStoreArr(arrName, idx, key, val) { getCurrentData().depts['store'][arrName][idx][key] = val; saveDB(); }
        function removeStoreArr(arrName, idx) { getCurrentData().depts['store'][arrName].splice(idx, 1); saveDB(); renderModalContent(); }

        // --- Init ---
        function renderMonthSelector() { const sel=document.getElementById('monthSelector'); sel.innerHTML=''; Object.keys(db).sort().reverse().forEach(k=>{const opt=document.createElement('option'); opt.value=k; opt.text=k; if(k===currentMonthKey) opt.selected=true; sel.appendChild(opt);}); }
        function changeMonth() { currentMonthKey = document.getElementById('monthSelector').value; renderDashboard(); saveDB(); }
        function createNewMonth() { const k=prompt("Ø§Ù„Ø´Ù‡Ø± (YYYY-MM):", new Date().toISOString().slice(0,7)); if(k&&!db[k]){ db[k]={depts:JSON.parse(JSON.stringify(defaultDeptStructure)),texts:{}}; currentMonthKey=k; saveDB(); init(); } }
        function resetCurrentMonth() { if(confirm("Ø­Ø°ÙØŸ")) { delete db[currentMonthKey]; localStorage.removeItem('IMSY_DB_V9_2'); location.reload(); } }
        let isEditMode = false; function toggleEditMode() { isEditMode=!isEditMode; document.querySelectorAll('.editable-text').forEach(el => { el.contentEditable=isEditMode; el.classList.toggle('editable-active'); el.onblur=function(){const id=this.getAttribute('data-id'); if(!getCurrentData().texts) getCurrentData().texts={}; getCurrentData().texts[id]=this.innerText; saveDB();}}); }

        window.addEventListener('load', init);
    </script>
</body>
</html>
