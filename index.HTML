<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMSY | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0b1121', 800: '#151e32', 700: '#2a3b55' },
                        brand: { cyan: '#06b6d4', blue: '#3b82f6', orange: '#f97316', green: '#10b981', red: '#ef4444', yellow: '#eab308' }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Screen Styles --- */
        body {
            background-color: #0b1121;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(6, 182, 212, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(249, 115, 22, 0.05), transparent 25%);
            color: #e2e8f0;
        }

        .glass-card {
            background: rgba(21, 30, 50, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(6, 182, 212, 0.3);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.4);
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(11, 17, 33, 0.95);
            backdrop-filter: blur(5px);
            z-index: 50; display: none;
            justify-content: center; align-items: flex-start;
            padding-top: 2rem; padding-bottom: 2rem;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #151e32; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 1.5rem; width: 95%; max-width: 1200px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: auto; min-height: 80vh;
        }

        .table-input {
            background: transparent; border: 1px solid transparent; width: 100%; color: white;
            text-align: center; padding: 6px; outline: none; border-radius: 4px;
        }
        .table-input:focus, .table-input:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); }
        
        .editable-active { outline: 2px dashed #06b6d4; background: rgba(6, 182, 212, 0.1); }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white !important; color: black !important; font-size: 10pt; }
            .no-print, #editBtn, header button, .add-row-btn, .remove-row-btn, .nav-btn { display: none !important; }
            
            /* Print Specific Visibility */
            .print-only { display: block !important; }
            .screen-only { display: none !important; }

            /* Modal Logic for Print */
            body.modal-open > *:not(.modal-overlay) { display: none !important; }
            body.modal-open .modal-overlay { 
                position: static; background: white; display: block; overflow: visible; padding: 0;
            }
            body.modal-open .modal-content {
                width: 100%; max-width: none; border: none; box-shadow: none; background: white; color: black; margin: 0; min-height: auto;
            }
            
            /* Table Styling */
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; page-break-inside: avoid; }
            th, td { border: 1px solid #000 !important; padding: 6px; text-align: center; color: black !important; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            
            /* Reset Colors */
            .text-white { color: black !important; }
            .text-slate-400 { color: #333 !important; }
            .bg-slate-800, .bg-slate-900, .glass-card { background: white !important; border: 1px solid #ccc !important; }
            
            /* Report Sections */
            .engineer-report-page { page-break-after: always; margin-bottom: 2rem; border-bottom: 1px dashed #ccc; padding-bottom: 2rem; }
            .engineer-report-page:last-child { page-break-after: auto; }

            canvas { max-height: 400px !important; width: 100% !important; filter: none !important; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 antialiased">

    <!-- Top Control Bar -->
    <div class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center bg-slate-800/80 p-4 rounded-2xl border border-slate-700 no-print">
        <div class="flex items-center gap-4">
            <label class="text-sm text-slate-400">ğŸ“… Ø§Ù„Ø´Ù‡Ø±:</label>
            <select id="monthSelector" onchange="changeMonth()" class="bg-slate-900 text-white border border-slate-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 outline-none"></select>
            <button onclick="createNewMonth()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-bold transition">+ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="flex gap-3 mt-4 md:mt-0">
            <button onclick="toggleEditMode()" id="editBtn" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold transition"><span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ</button>
            <button onclick="window.print()" class="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold transition"><span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ù…Ø©</button>
            <button onclick="resetCurrentMonth()" class="bg-red-900/50 hover:bg-red-900 text-red-200 px-3 py-2 rounded-lg text-sm transition">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
    </div>

    <!-- Main Header -->
    <header class="max-w-7xl mx-auto mb-8 border-b border-slate-700 pb-6">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-black text-white tracking-tight editable-text" data-id="main-title">
                    Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØµÙ†Ø¹ <span class="text-cyan-500 print:text-black">IMSY</span>
                </h1>
                <p class="text-slate-400 mt-1 editable-text" data-id="main-subtitle">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</p>
            </div>
            <div class="text-left">
                <div class="text-sm text-slate-500">Ø§Ù„ÙØªØ±Ø©</div>
                <div class="text-2xl font-bold text-white print:text-black" id="displayPeriod">ÙŠÙ†Ø§ÙŠØ± 2026</div>
            </div>
        </div>
    </header>

    <!-- Overview Section (REINSTATED) -->
    <section class="max-w-7xl mx-auto mb-8">
        <div class="glass-card p-6 md:p-8">
            <div class="flex flex-col md:flex-row items-center gap-8">
                <div class="w-full md:w-1/3">
                    <h2 class="text-2xl font-bold text-white mb-4">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</h2>
                    <div class="space-y-4">
                        <div class="bg-slate-900/50 print:bg-gray-100 p-4 rounded-lg border border-slate-700 print:border-gray-300">
                            <div class="text-sm text-slate-400">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙƒÙ„ÙŠ</div>
                            <div class="text-3xl font-bold text-cyan-400 print:text-black" id="overallScore">0%</div>
                        </div>
                        <div class="p-4 rounded-lg border border-dashed border-slate-600">
                            <div class="text-sm text-slate-400 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</div>
                            <p class="text-sm text-white editable-text print:text-black" data-id="manager-notes">
                                Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµÙ†Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±...
                            </p>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-2/3 h-64">
                    <canvas id="mainRadarChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Departments Grid -->
    <main class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        <!-- Generated by JS -->
    </main>

    <!-- Modal Container -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content p-6 md:p-10" onclick="event.stopPropagation()">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4 no-print">
                <div>
                    <h2 id="modalTitle" class="text-3xl font-black text-white mb-1"></h2>
                    <p class="text-slate-400 text-sm">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    <button onclick="closeModalBtn()" class="text-2xl text-slate-400 hover:text-white ml-4 bg-slate-800 w-10 h-10 rounded-full flex items-center justify-center">âœ•</button>
                </div>
            </div>

            <!-- Modal Body (Dynamic Injection) -->
            <div id="modalBody"></div>

        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50">ØªÙ… Ø§Ù„Ø­ÙØ¸!</div>

    <script>
        // --- 1. CONFIGURATION ---
        const defaultDeptStructure = {
            'tech': { 
                title: 'Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ', icon: 'ğŸ“', color: '#3b82f6', 
                engineers: [], // Array of objects
                kpiLabels: ['Ø¯Ù‚Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…', 'Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²'], values: [85, 90] 
            },
            'prod': { 
                title: 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬', icon: 'âš™ï¸', color: '#f97316', 
                kpiLabels: ['Ø§Ù„Ø®Ø·Ø©', 'Ø§Ù„ÙƒÙØ§Ø¡Ø©', 'Ø§Ù„Ù‡Ø§Ù„Ùƒ'], values: [90, 85, 95],
                tasks: ['Laser Cutting', 'Bending', 'Assembly'], notes: '...'
            },
            'qual': { 
                title: 'Ø§Ù„Ø¬ÙˆØ¯Ø©', icon: 'ğŸ›¡ï¸', color: '#10b981', 
                kpiLabels: ['Ø§Ù„Ù‚Ø¨ÙˆÙ„', 'Ø§Ù„ÙØ­Øµ', 'Ø§Ù„Ø¹Ù…ÙŠÙ„'], values: [95, 92, 98],
                tasks: ['Incoming QC', 'Final QC'], notes: '...'
            },
            'maint': { 
                title: 'Ø§Ù„ØµÙŠØ§Ù†Ø©', icon: 'ğŸ”§', color: '#ef4444', 
                kpiLabels: ['Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©', 'Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©'], values: [88, 90],
                tasks: ['Preventive', 'Corrective'], notes: '...'
            },
            'safety': { 
                title: 'Ø§Ù„Ø³Ù„Ø§Ù…Ø©', icon: 'ğŸ¦º', color: '#eab308', 
                kpiLabels: ['PPE', 'Ø§Ù„Ø­ÙˆØ§Ø¯Ø«'], values: [98, 100],
                tasks: ['PPE Check', 'Training'], notes: '...'
            }
        };

        // --- 2. DB MANAGEMENT (V6) ---
        let db = JSON.parse(localStorage.getItem('IMSY_DB_V6')) || {};
        let currentMonthKey = localStorage.getItem('IMSY_CURRENT_MONTH_V6');

        if (Object.keys(db).length === 0) {
            const now = new Date();
            const key = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            db[key] = { depts: JSON.parse(JSON.stringify(defaultDeptStructure)), texts: {} };
            currentMonthKey = key;
            saveDB();
        }
        if (!currentMonthKey || !db[currentMonthKey]) currentMonthKey = Object.keys(db).sort().pop();

        function saveDB() {
            localStorage.setItem('IMSY_DB_V6', JSON.stringify(db));
            localStorage.setItem('IMSY_CURRENT_MONTH_V6', currentMonthKey);
            showToast();
        }
        function getCurrentData() { return db[currentMonthKey]; }
        function showToast() { const t = document.getElementById('toast'); t.style.opacity='1'; setTimeout(()=>t.style.opacity='0', 1000); }
        function init() { renderMonthSelector(); renderDashboard(); }

        // --- 3. RENDERING DASHBOARD ---
        let mainRadarChartInstance = null;

        function renderDashboard() {
            const data = getCurrentData();
            document.getElementById('displayPeriod').innerText = currentMonthKey;
            
            // 1. Render Chart
            updateMainRadarChart(data);

            // 2. Render Cards
            const container = document.querySelector('main');
            container.innerHTML = ''; 

            Object.entries(data.depts).forEach(([key, dept]) => {
                let avg = 0;
                // Calculate average for card display
                if(key === 'tech' && dept.engineers && dept.engineers.length > 0) {
                    // Tech avg based on engineers performance (mock calculation for visual)
                    // Assuming base performance minus errors
                    let total = 0;
                    dept.engineers.forEach(e => total += (100 - (e.errorCount || 0) * 5));
                    avg = Math.max(0, Math.round(total / dept.engineers.length));
                } else if(dept.values && dept.values.length > 0) {
                    avg = Math.round(dept.values.reduce((a, b) => a + b, 0) / dept.values.length);
                } else {
                    avg = 0; // Default
                }
                
                const card = document.createElement('div');
                card.className = 'glass-card p-6 group';
                card.onclick = () => openModal(key);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl transition" 
                             style="background: ${dept.color}20; color: ${dept.color}">${dept.icon}</div>
                        <div class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded font-bold">${avg}%</div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">${dept.title}</h3>
                    <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden mb-2">
                        <div class="h-full" style="width: ${avg}%; background-color: ${dept.color}"></div>
                    </div>
                    <p class="text-xs text-slate-400">${key==='tech' ? (dept.engineers ? dept.engineers.length : 0) + ' Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†' : 'Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„'}</p>
                `;
                container.appendChild(card);
            });

            // Restore editable texts
            document.querySelectorAll('.editable-text').forEach(el => {
                const id = el.getAttribute('data-id');
                if(data.texts && data.texts[id]) el.innerText = data.texts[id];
            });
        }

        function updateMainRadarChart(data) {
            const ctx = document.getElementById('mainRadarChart').getContext('2d');
            const labels = [];
            const values = [];
            let totalSum = 0; 
            let count = 0;

            Object.values(data.depts).forEach(dept => {
                labels.push(dept.title);
                let avg = 0;
                if(dept.title.includes('Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ') && dept.engineers && dept.engineers.length > 0) {
                     let total = 0;
                     dept.engineers.forEach(e => total += (100 - (e.errorCount || 0) * 5));
                     avg = Math.max(0, Math.round(total / dept.engineers.length));
                } else {
                    avg = dept.values.reduce((a,b)=>a+b,0) / dept.values.length;
                }
                values.push(avg);
                totalSum += avg;
                count++;
            });

            document.getElementById('overallScore').innerText = Math.round(totalSum/count) + '%';

            if (mainRadarChartInstance) mainRadarChartInstance.destroy();

            mainRadarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ',
                        data: values,
                        backgroundColor: 'rgba(6, 182, 212, 0.2)',
                        borderColor: '#06b6d4',
                        pointBackgroundColor: '#fff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#94a3b8', font: { size: 11 } },
                            suggestedMin: 0, suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 4. MODAL LOGIC (FIXED) ---
        let currentModalKey = null;
        let currentTechView = 'list';
        let currentEngIndex = null;

        function openModal(key) {
            currentModalKey = key;
            const data = getCurrentData().depts[key];
            document.getElementById('modalTitle').innerText = data.title;
            document.body.classList.add('modal-open');
            
            // Reset state on fresh open
            currentTechView = 'list';
            currentEngIndex = null;

            renderModalContent(); // Render based on state
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function renderModalContent() {
            const data = getCurrentData().depts[currentModalKey];
            const container = document.getElementById('modalBody');
            
            if (currentModalKey === 'tech') {
                renderTechModal(data, container);
            } else {
                renderStandardModal(data, container);
            }
        }

        // --- 5. TECH OFFICE LOGIC ---
        function renderTechModal(data, container) {
            // VIEW 1: LIST
            if (currentTechView === 'list') {
                let listHtml = '';
                if (!data.engineers || data.engineers.length === 0) {
                    listHtml = `<div class="text-center py-10 text-slate-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†. Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ©.</div>`;
                } else {
                    data.engineers.forEach((eng, idx) => {
                        listHtml += `
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center group mb-2">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-900 text-blue-300 flex items-center justify-center font-bold">${(eng.name || '?')[0]}</div>
                                    <div>
                                        <h4 class="font-bold text-white">${eng.name || 'Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯'}</h4>
                                        <p class="text-xs text-slate-400">${(eng.machines || []).length} Ù…Ø§ÙƒÙŠÙ†Ø§Øª</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editEngineer(${idx})" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button onclick="deleteEngineer(${idx})" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm">Ø­Ø°Ù</button>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = `
                    <div class="screen-only flex justify-between mb-6">
                        <h3 class="text-xl font-bold text-cyan-400">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h3>
                        <div class="flex gap-2">
                            <button onclick="switchTechView('summary')" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-bold">ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ</button>
                            <button onclick="addNewEngineer()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù†Ø¯Ø³</button>
                        </div>
                    </div>
                    <div class="space-y-4 screen-only">${listHtml}</div>
                    
                    <!-- Print Only -->
                    <div class="hidden print:block">
                        ${generateAllEngineersPrintHtml(data.engineers)}
                        <div class="page-break"></div>
                        ${generateTechSummaryHtml(data.engineers)}
                    </div>
                `;
            } 
            // VIEW 2: DETAIL
            else if (currentTechView === 'detail') {
                const eng = data.engineers[currentEngIndex];
                
                // Machines Rows
                const machinesRows = (eng.machines || []).map((m, i) => `
                    <tr>
                        <td><input class="table-input bg-slate-900 border-slate-700" value="${m.name}" onblur="updateEngArr(${currentEngIndex}, 'machines', ${i}, 'name', this.value)" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©"></td>
                        <td><input class="table-input bg-slate-900 border-slate-700" value="${m.notes}" onblur="updateEngArr(${currentEngIndex}, 'machines', ${i}, 'notes', this.value)" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„"></td>
                        <td class="no-print"><button onclick="removeEngArr(${currentEngIndex}, 'machines', ${i})" class="text-red-400">Ã—</button></td>
                    </tr>
                `).join('');

                // Lateness Rows
                const latenessRows = (eng.latenessLog || []).map((l, i) => `
                    <tr>
                        <td><input class="table-input bg-slate-900 border-slate-700" type="date" value="${l.day}" onblur="updateEngArr(${currentEngIndex}, 'latenessLog', ${i}, 'day', this.value)"></td>
                        <td><input class="table-input bg-slate-900 border-slate-700" type="number" value="${l.hours}" onblur="updateEngArr(${currentEngIndex}, 'latenessLog', ${i}, 'hours', this.value)"></td>
                        <td class="no-print"><button onclick="removeEngArr(${currentEngIndex}, 'latenessLog', ${i})" class="text-red-400">Ã—</button></td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <div class="flex items-center gap-4 mb-6 no-print">
                        <button onclick="switchTechView('list')" class="bg-slate-700 text-white px-3 py-1 rounded">â¬… Ø±Ø¬ÙˆØ¹</button>
                        <h3 class="text-xl font-bold text-white">ØªØ¹Ø¯ÙŠÙ„: <span class="text-cyan-400">${eng.name}</span></h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-800 p-6 rounded-xl border border-slate-700 mb-6">
                        <div>
                            <label class="text-slate-400 text-xs">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</label>
                            <input class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white mt-1" 
                                   value="${eng.name}" onblur="updateEngField(${currentEngIndex}, 'name', this.value)">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-slate-400 text-xs text-red-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</label>
                                <input type="number" class="w-full bg-slate-900 border border-red-900/50 rounded p-2 text-white mt-1 text-center" 
                                       value="${eng.errorCount || 0}" onblur="updateEngField(${currentEngIndex}, 'errorCount', this.value)">
                            </div>
                            <div>
                                <label class="text-slate-400 text-xs text-green-400">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
                                <input class="w-full bg-slate-900 border border-green-900/50 rounded p-2 text-white mt-1 text-center" 
                                       value="${eng.handoverStatus || 'ØªÙ…Ø§Ù…'}" onblur="updateEngField(${currentEngIndex}, 'handoverStatus', this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                            <div class="flex justify-between mb-2">
                                <h4 class="text-blue-400 font-bold">ğŸ› ï¸ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</h4>
                                <button onclick="addEngArr(${currentEngIndex}, 'machines')" class="text-xs bg-blue-600 px-2 py-1 rounded text-white no-print">+ Ø¥Ø¶Ø§ÙØ©</button>
                            </div>
                            <table class="w-full text-sm text-slate-300">
                                <thead><tr class="text-slate-500 border-b border-slate-700"><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th></th></tr></thead>
                                <tbody>${machinesRows}</tbody>
                            </table>
                        </div>

                        <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                            <div class="flex justify-between mb-2">
                                <h4 class="text-red-400 font-bold">â° Ø³Ø¬Ù„ Ø§Ù„ØªØ£Ø®ÙŠØ±Ø§Øª</h4>
                                <button onclick="addEngArr(${currentEngIndex}, 'latenessLog')" class="text-xs bg-red-600 px-2 py-1 rounded text-white no-print">+ Ø¥Ø¶Ø§ÙØ©</button>
                            </div>
                            <table class="w-full text-sm text-slate-300">
                                <thead><tr class="text-slate-500 border-b border-slate-700"><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th><th></th></tr></thead>
                                <tbody>${latenessRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            // VIEW 3: SUMMARY
            else if (currentTechView === 'summary') {
                container.innerHTML = `
                    <div class="flex items-center gap-4 mb-6 no-print">
                        <button onclick="switchTechView('list')" class="bg-slate-700 text-white px-3 py-1 rounded">â¬… Ø±Ø¬ÙˆØ¹</button>
                        <h3 class="text-xl font-bold text-white">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
                    </div>
                    ${generateTechSummaryHtml(data.engineers)}
                `;
                setTimeout(() => renderSummaryChart(data.engineers), 100);
            }
        }

        // --- Tech Office Actions ---
        function switchTechView(view) {
            currentTechView = view;
            renderModalContent(); // Re-render without closing/opening
        }

        function addNewEngineer() {
            const data = getCurrentData().depts['tech'];
            if(!data.engineers) data.engineers = [];
            data.engineers.push({
                name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯', machines: [], latenessLog: [], errorCount: 0, handoverStatus: 'Ø¬Ø§Ø±ÙŠ'
            });
            saveDB();
            currentEngIndex = data.engineers.length - 1;
            switchTechView('detail');
        }

        function editEngineer(index) {
            currentEngIndex = index;
            switchTechView('detail');
        }

        function deleteEngineer(index) {
            if(confirm('Ø­Ø°ÙØŸ')) {
                getCurrentData().depts['tech'].engineers.splice(index, 1);
                saveDB();
                renderModalContent();
            }
        }

        function updateEngField(idx, f, v) {
            getCurrentData().depts['tech'].engineers[idx][f] = v;
            saveDB();
        }
        function updateEngArr(eIdx, arr, iIdx, key, val) {
            getCurrentData().depts['tech'].engineers[eIdx][arr][iIdx][key] = val;
            saveDB();
        }
        function addEngArr(eIdx, arr) {
            const e = getCurrentData().depts['tech'].engineers[eIdx];
            if(arr === 'machines') e.machines.push({name:'', notes:''});
            if(arr === 'latenessLog') e.latenessLog.push({day:'', hours:0});
            saveDB();
            renderModalContent();
        }
        function removeEngArr(eIdx, arr, iIdx) {
            getCurrentData().depts['tech'].engineers[eIdx][arr].splice(iIdx, 1);
            saveDB();
            renderModalContent();
        }

        // --- 6. PRINT GENERATORS ---
        function generateAllEngineersPrintHtml(engineers) {
            if(!engineers || engineers.length === 0) return '';
            return engineers.map(eng => `
                <div class="engineer-report-page">
                    <h3 class="text-xl font-bold bg-gray-200 p-2 border border-black mb-4">ØªÙ‚Ø±ÙŠØ±: ${eng.name}</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4 border border-black p-2">
                        <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</strong> ${eng.errorCount || 0}</div>
                        <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> ${eng.handoverStatus || '-'}</div>
                    </div>
                    <h4 class="font-bold border-b border-black mb-2 mt-4">1. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</h4>
                    <table class="w-full mb-4">
                        <thead><tr><th>Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th></tr></thead>
                        <tbody>${(eng.machines||[]).map((m,i)=>`<tr><td>${i+1}</td><td>${m.name}</td><td>${m.notes}</td></tr>`).join('') || '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody>
                    </table>
                    <h4 class="font-bold border-b border-black mb-2 mt-4">2. Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h4>
                    <table class="w-full">
                        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ£Ø®ÙŠØ±</th></tr></thead>
                        <tbody>${(eng.latenessLog||[]).map(l=>`<tr><td>${l.day}</td><td>${l.hours}</td></tr>`).join('') || '<tr><td colspan="2">Ù…Ù†ØªØ¸Ù…</td></tr>'}</tbody>
                    </table>
                    <div class="mt-8 flex justify-between"><div class="text-center">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³<br>...</div><div class="text-center">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ<br>...</div></div>
                </div>
            `).join('');
        }

        function generateTechSummaryHtml(engineers) {
            if(!engineers || engineers.length === 0) return '';
            const totalErr = engineers.reduce((s,e)=>s+Number(e.errorCount||0),0);
            const totalMac = engineers.reduce((s,e)=>s+(e.machines?.length||0),0);
            const topEng = engineers.reduce((p,c)=>((p.machines?.length||0) > (c.machines?.length||0)) ? p : c, engineers[0]);
            
            return `
                <div class="bg-white text-black p-6 rounded-xl border border-gray-300">
                    <div class="grid grid-cols-3 gap-6 mb-8 text-center">
                        <div class="p-4 border border-blue-500 rounded-lg">
                            <div class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª</div><div class="text-3xl font-bold text-blue-600">${totalMac}</div>
                        </div>
                        <div class="p-4 border border-red-500 rounded-lg">
                            <div class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div><div class="text-3xl font-bold text-red-600">${totalErr}</div>
                        </div>
                        <div class="p-4 border border-green-500 rounded-lg">
                            <div class="text-sm text-gray-600">Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†ØªØ§Ø¬Ø§Ù‹</div><div class="text-xl font-bold text-green-600">${topEng.name}</div>
                        </div>
                    </div>
                    <div class="h-64 w-full border border-gray-200 p-4 rounded bg-gray-50"><canvas id="techSummaryChart"></canvas></div>
                </div>
            `;
        }

        function renderSummaryChart(engineers) {
            const ctx = document.getElementById('techSummaryChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: engineers.map(e => e.name),
                    datasets: [
                        { label: 'Ù…Ø§ÙƒÙŠÙ†Ø§Øª', data: engineers.map(e=>e.machines?.length||0), backgroundColor: '#3b82f6' },
                        { label: 'Ø£Ø®Ø·Ø§Ø¡', data: engineers.map(e=>e.errorCount||0), backgroundColor: '#ef4444' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        // --- 7. STANDARD MODAL ---
        function renderStandardModal(data, container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                        <h4 class="font-bold text-cyan-400 mb-6">âš™ï¸ Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h4>
                        ${data.kpiLabels.map((l, i) => `
                            <div class="mb-4">
                                <div class="flex justify-between text-xs mb-1 text-slate-300"><span>${l}</span><span>${data.values[i]}%</span></div>
                                <input type="range" min="0" max="100" value="${data.values[i]}" oninput="updateVal(${i}, this.value)" style="width:100%; accent-color:${data.color}">
                            </div>`).join('')}
                    </div>
                    <div>
                        <h4 class="font-bold text-white mb-2">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
                        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                            <p class="text-sm text-slate-300 outline-none" contenteditable="true" onblur="saveDeptNotes(this.innerText)">${data.notes}</p>
                        </div>
                    </div>
                </div>`;
        }

        // --- Shared Helpers ---
        function updateVal(idx, val) {
            getCurrentData().depts[currentModalKey].values[idx] = Number(val);
            saveDB(); renderDashboard();
        }
        function saveDeptNotes(text) { getCurrentData().depts[currentModalKey].notes = text; saveDB(); }
        function closeModalBtn() { 
            document.getElementById('modalOverlay').classList.remove('active'); 
            document.body.classList.remove('modal-open');
            renderDashboard(); // Update main chart when closing
        }
        function closeModal(e) { if(e.target.id === 'modalOverlay') closeModalBtn(); }

        // --- Init Helpers ---
        function renderMonthSelector() {
            const sel = document.getElementById('monthSelector'); sel.innerHTML = '';
            Object.keys(db).sort().reverse().forEach(k => {
                const opt = document.createElement('option'); opt.value = k; opt.text = k;
                if(k === currentMonthKey) opt.selected = true; sel.appendChild(opt);
            });
        }
        function changeMonth() { currentMonthKey = document.getElementById('monthSelector').value; renderDashboard(); saveDB(); }
        function createNewMonth() {
            const k = prompt("Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (YYYY-MM):", new Date().toISOString().slice(0,7));
            if(k && !db[k]) { db[k] = { depts: JSON.parse(JSON.stringify(defaultDeptStructure)), texts: {} }; currentMonthKey = k; saveDB(); init(); }
        }
        function resetCurrentMonth() { if(confirm("Ø­Ø°ÙØŸ")) { delete db[currentMonthKey]; localStorage.removeItem('IMSY_DB_V6'); location.reload(); } }
        let isEditMode = false;
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const els = document.querySelectorAll('.editable-text');
            const btn = document.getElementById('editBtn');
            if (isEditMode) {
                btn.classList.add('bg-cyan-600');
                els.forEach(el => { el.contentEditable = true; el.classList.add('editable-active'); el.onblur = function() { const id = this.getAttribute('data-id'); if(!getCurrentData().texts) getCurrentData().texts = {}; getCurrentData().texts[id] = this.innerText; saveDB(); }});
            } else {
                btn.classList.remove('bg-cyan-600'); els.forEach(el => { el.contentEditable = false; el.classList.remove('editable-active'); });
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
